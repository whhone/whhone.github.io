<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Installing Arch Linux with Full Disk Encryption | Wai Hon&#39;s Blog</title>

<meta name="keywords" content="privacy, arch-linux" />
<meta name="description" content="I recently re-installed my Arch Linux with full disk encryption (FDE), as one of the first steps, to bring privacy into my life. This guide documents the installation process in a step-by-step manner. I hope this can help people who also want to practice privacy.
Each step in this guide are linked to the corresponding ArchWiki, precised to section level. You are suggested to read these references and, of course, the official installation guide because">
<meta name="author" content="">
<link rel="canonical" href="https://whhone.github.io/blog/posts/arch-linux-full-disk-encryption/" />
<link href="/blog/assets/css/stylesheet.min.6fdf38588ea13f9fcfd31bf64487e300c670aec39f9ab8cf5473a494b8097993.css" integrity="sha256-b984WI6hP5/P0xv2RIfjAMZwrsOfmrjPVHOklLgJeZM=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://whhone.github.io/blog/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://whhone.github.io/blog/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://whhone.github.io/blog/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://whhone.github.io/blog/apple-touch-icon.png">
<link rel="mask-icon" href="https://whhone.github.io/blog/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.82.0" />



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-38001261-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta property="og:title" content="Installing Arch Linux with Full Disk Encryption" />
<meta property="og:description" content="I recently re-installed my Arch Linux with full disk encryption (FDE), as one of the first steps, to bring privacy into my life. This guide documents the installation process in a step-by-step manner. I hope this can help people who also want to practice privacy.
Each step in this guide are linked to the corresponding ArchWiki, precised to section level. You are suggested to read these references and, of course, the official installation guide because" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://whhone.github.io/blog/posts/arch-linux-full-disk-encryption/" />
<meta property="article:published_time" content="2020-07-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-29T00:00:00+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Installing Arch Linux with Full Disk Encryption"/>
<meta name="twitter:description" content="I recently re-installed my Arch Linux with full disk encryption (FDE), as one of the first steps, to bring privacy into my life. This guide documents the installation process in a step-by-step manner. I hope this can help people who also want to practice privacy.
Each step in this guide are linked to the corresponding ArchWiki, precised to section level. You are suggested to read these references and, of course, the official installation guide because"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://whhone.github.io/blog/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Installing Arch Linux with Full Disk Encryption",
      "item": "https://whhone.github.io/blog/posts/arch-linux-full-disk-encryption/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Installing Arch Linux with Full Disk Encryption",
  "name": "Installing Arch Linux with Full Disk Encryption",
  "description": "I recently re-installed my Arch Linux with full disk encryption (FDE), as one of the first steps, to bring privacy into my life. This guide documents the installation process in a …",
  "keywords": [
    "privacy", "arch-linux"
  ],
  "articleBody": "I recently re-installed my Arch Linux with full disk encryption (FDE), as one of the first steps, to bring privacy into my life. This guide documents the installation process in a step-by-step manner. I hope this can help people who also want to practice privacy.\nEach step in this guide are linked to the corresponding ArchWiki, precised to section level. You are suggested to read these references and, of course, the official installation guide because\n it is better to understand the process instead of blindly copy-and-pase, and I had omitted some uncommon steps that you might need (e.g., non US locale and keyboard layout)  This guide uses modern options like:\n    Options This Setup     Disk Encryption Yes, No Yes   Firmware BIOS, UEFI UEFI   Disk Partition MBR, GPT GPT   Boot Loader GRUB, Syslinux, systemd-boot, etc systemd-boot    In addition, I have verified this guide twice by installing on both hard disk and virtual machine respectively. I think it is reproducible.\nLet’s start!\n1. Verify the boot mode (ref) This guide assumes we use UEFI. You must ensure that the system is booted in UEFI mode. To verify the boot mode, list the efivars directory:\n# ls /sys/firmware/efi/efivars If the command shows the directory without error, then the system is booted in UEFI mode.\n2. Update the system clock (ref) Use timedatectl to ensure the system clock is accurate:\n# timedatectl set-ntp true 3. Partition the disks (ref, GPT fdisk) The final disk layout from this guide contains two partitions,\n   Partition Size Code Name     Boot (/dev/sda1) 512.0 MiB EF00 EFI system partition   Root (/dev/sda2) Rest of the disk 8300 (default of gdisk) Linux filesystem    Traditionally, it is suggested to create an extra swap partition. I don’t because there are more flexible alternatives over allocating a fixed partition for swap. For example, uses swap file, or systemd-swap to automate the swap file on demand.\nUse gdisk to partition the disk. See this video:\n  When completed, gdisk -l /dev/sda should print the disk partitions like these:\nGPT fdisk (gdisk) version 1.0.5 Partition table scan: MBR: protective BSD: not present APM: not present GPT: present Found valid GPT with protective MBR; using GPT. Disk /dev/sda: 41943040 sectors, 20.0 GiB Model: VBOX HARDDISK Sector size (logical/physical): 512/512 bytes Disk identifier (GUID): 8EFD04A2-473C-4FCA-9C89-459EEB658DB0 Partition table holds up to 128 entries Main partition table begins at sector 2 and ends at sector 33 First usable sector is 34, last usable sector is 41943006 Partitions will be aligned on 2048-sector boundaries Total free space is 2014 sectors (1007.0 KiB) Number Start (sector) End (sector) Size Code Name 1 2048 1050623 512.0 MiB EF00 EFI system partition 2 1050624 41943006 19.5 GiB 8300 Linux filesystem 4. Prepare the encrypted root partition (ref) Create and mount the encrypted root partition. You will need to choose the passphrase for the encryption!\n# cryptsetup luksFormat /dev/sda2 # cryptsetup open /dev/sda2 cryptroot # mkfs.ext4 /dev/mapper/cryptroot # mount /dev/mapper/cryptroot /mnt 5. Prepare the boot partition (ref) Create and mount the non-encrypted boot partition.\n# mkfs.fat -F32 /dev/sda1 # mkdir /mnt/boot # mount /dev/sda1 /mnt/boot 6. Generate an fstab file (ref) Run:\n# genfstab -U /mnt  /mnt/etc/fstab 7. Install essential packages (ref) Use the pacstrap script to install these packages. I added vim for editing config files and dhcpcd for connecting to the Internet after reboot.\n# pacstrap /mnt base linux linux-firmware vim dhcpcd 8. Chroot (ref) # arch-chroot /mnt 9. Time zone (ref) # ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime # hwclock --systohc 10. Localization (ref) Edit /etc/locale.gen and uncomment en_US.UTF-8 UTF-8 and other needed locales. Generate the locales by running:\n# locale-gen # localectl set-locale LANG=en_US.UTF-8 11. Network configuration (ref) Add the /etc/hosts:\n127.0.0.1 localhost ::1 localhost 12. Configuring mkinitcpio (ref) Edit /etc/mkinitcpio.conf,\n add the encrypt hooks move the keyboard hooks before encrypt ( so that you can type the passphrase :p )  For example, after this step, HOOKS should look like:\nHOOKS=(base udev autodetect modconf block keyboard encrypt filesystems fsck) 13. Generate the initramfs (ref) Since we have changed to /etc/mkinitcpio.conf manually, we have to re-generates the boot images (e.g., /boot/initramfs-linux.img). Run this command:\n# mkinitcpio -P 14. Set the root password (ref) # passwd 15. Patch the CPU’s microcode (ref)  For AMD processors, install the amd-ucode package. For Intel processors, install the intel-ucode package.  For exmaple, run\n# pacman -S intel-ucode 16. Configure the Boot Loader with systemd-boot (ref, systemd-boot) 16.1. Install the EFI boot manager\n# bootctl install 16.2. Create /boot/loader/entries/arch.conf\n Replace intel-ucode.img with amd-ucode.img if you have an AMD CPU Replace the UUID (not PARTUUID) to the one mapping to /dev/sda2 (Run blkid to find out)  title Arch Linux linux /vmlinuz-linux initrd /intel-ucode.img initrd /initramfs-linux.img options cryptdevice=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX:cryptroot root=/dev/mapper/cryptroot rw 16.3. Replace /boot/loader/loader.conf to\ndefault arch.conf timeout 5 console-mode max editor no 16.4. Review the configuration\n# bootctl list Boot Loader Entries: title: Arch Linux (default) id: arch.conf source: /boot/loader/entries/arch.conf linux: /vmlinuz-linux initrd: /intel-ucode.img /initramfs-linux.img options: cryptdevice=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX:cryptroot root=/dev/mapper/cryptroot rw 17. Reboot (ref) Exit the chroot environment by typing exit or pressing Ctrl+d. Then run reboot.\nIf everything works, it should ask for a password to access the cryptroot, like this screenshot below:\nOne last thing, if you computer, like mine, is sitting behind a DHCP (e.g., a typical router), you will need to enable dhcpcd to access the Internet. Run,\n# systemctl enable dhcpcd Congratulations! You have installed Arch Linux with Full Disk Encryption!\n",
  "wordCount" : "890",
  "inLanguage": "en",
  "datePublished": "2020-07-29T00:00:00Z",
  "dateModified": "2020-07-29T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://whhone.github.io/blog/posts/arch-linux-full-disk-encryption/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Wai Hon's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://whhone.github.io/blog/favicon.ico"
    }
  }
}
</script>





</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://whhone.github.io/blog/" accesskey="h" title="Wai Hon&#39;s Blog (Alt + H)">Wai Hon&#39;s Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                
                
            </span>
        </div>
        <ul id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://whhone.github.io/blog/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://whhone.github.io/blog/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://whhone.github.io/blog/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://whhone.github.io/blog/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://whhone.github.io/blog/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://whhone.github.io/blog/index.xml" title="RSS">
                    <span>RSS</span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">

    <h1 class="post-title">
      Installing Arch Linux with Full Disk Encryption
    </h1>
    <div class="post-meta">July 29, 2020

</div>
  </header> 

  <div class="post-content">
<p>I recently re-installed my Arch Linux with <a href="https://en.wikipedia.org/wiki/Disk_encryption">full disk encryption (FDE)</a>, as one of the first steps, to bring <a href="https://www.ted.com/talks/glenn_greenwald_why_privacy_matters">privacy</a> into my life. This guide documents the installation process in a step-by-step manner. I hope this can help people who also want to practice privacy.</p>
<p>Each step in this guide are linked to the corresponding ArchWiki, precised to section level. You are suggested to read these references and, of course, the <a href="https://wiki.archlinux.org/index.php/installation_guide">official installation guide</a> because</p>
<ul>
<li>it is better to understand the process instead of blindly copy-and-pase, and</li>
<li>I had omitted some uncommon steps that you might need (e.g., non US locale and keyboard layout)</li>
</ul>
<p>This guide uses modern options like:</p>
<table>
<thead>
<tr>
<th></th>
<th>Options</th>
<th>This Setup</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Disk Encryption</strong></td>
<td>Yes, No</td>
<td><strong>Yes</strong></td>
</tr>
<tr>
<td><strong>Firmware</strong></td>
<td>BIOS, UEFI</td>
<td><strong>UEFI</strong></td>
</tr>
<tr>
<td><strong>Disk Partition</strong></td>
<td>MBR, GPT</td>
<td><strong>GPT</strong></td>
</tr>
<tr>
<td><strong>Boot Loader</strong></td>
<td>GRUB, Syslinux, systemd-boot, etc</td>
<td><strong>systemd-boot</strong></td>
</tr>
</tbody>
</table>
<p>In addition, I have verified this guide twice by installing on both hard disk and virtual machine respectively. I think it is reproducible.</p>
<p>Let&rsquo;s start!</p>
<h3 id="1-verify-the-boot-mode-refhttpswikiarchlinuxorgindexphpinstallation_guideverify_the_boot_mode">1. Verify the boot mode (<a href="https://wiki.archlinux.org/index.php/installation_guide#Verify_the_boot_mode">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#1-verify-the-boot-mode-refhttpswikiarchlinuxorgindexphpinstallation_guideverify_the_boot_mode">#</a></h3>
<p>This guide assumes we use UEFI. You must ensure that the system is booted in UEFI mode. To verify the boot mode, list the efivars directory:</p>
<pre><code># ls /sys/firmware/efi/efivars
</code></pre><p>If the command shows the directory without error, then the system is booted in UEFI mode.</p>
<h3 id="2-update-the-system-clock-refhttpswikiarchlinuxorgindexphpinstallation_guideupdate_the_system_clock">2. Update the system clock (<a href="https://wiki.archlinux.org/index.php/installation_guide#Update_the_system_clock">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#2-update-the-system-clock-refhttpswikiarchlinuxorgindexphpinstallation_guideupdate_the_system_clock">#</a></h3>
<p>Use <code>timedatectl</code> to ensure the system clock is accurate:</p>
<pre><code># timedatectl set-ntp true
</code></pre><h3 id="3-partition-the-disks-refhttpswikiarchlinuxorgindexphpinstallation_guidepartition_the_disks-gpt-fdiskhttpswikiarchlinuxorgindexphpgpt_fdiskcreate_a_partition_table_and_partitions">3. Partition the disks (<a href="https://wiki.archlinux.org/index.php/installation_guide#Partition_the_disks">ref</a>, <a href="https://wiki.archlinux.org/index.php/GPT_fdisk#Create_a_partition_table_and_partitions">GPT fdisk</a>)<a hidden class="anchor" aria-hidden="true" href="#3-partition-the-disks-refhttpswikiarchlinuxorgindexphpinstallation_guidepartition_the_disks-gpt-fdiskhttpswikiarchlinuxorgindexphpgpt_fdiskcreate_a_partition_table_and_partitions">#</a></h3>
<p>The final disk layout from this guide contains two partitions,</p>
<table>
<thead>
<tr>
<th>Partition</th>
<th>Size</th>
<th>Code</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>Boot (/dev/sda1)</td>
<td>512.0 MiB</td>
<td>EF00</td>
<td>EFI system partition</td>
</tr>
<tr>
<td>Root (/dev/sda2)</td>
<td>Rest of the disk</td>
<td>8300 (default of gdisk)</td>
<td>Linux filesystem</td>
</tr>
</tbody>
</table>
<p><em>Traditionally, it is suggested to create an extra swap partition. I don&rsquo;t because there are more flexible alternatives over allocating a fixed partition for swap. For example, uses <a href="https://wiki.archlinux.org/index.php/swap#Swap_file">swap file</a>, or <a href="https://wiki.archlinux.org/index.php/swap#systemd-swap">systemd-swap</a> to automate the swap file on demand.</em></p>
<p>Use <code>gdisk</code> to partition the disk. See this video:</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube-nocookie.com/embed/AgMSMkpNnfY" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>When completed, <code>gdisk -l /dev/sda</code> should print the disk partitions like these:</p>
<pre><code>GPT fdisk (gdisk) version 1.0.5

Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present

Found valid GPT with protective MBR; using GPT.
Disk /dev/sda: 41943040 sectors, 20.0 GiB
Model: VBOX HARDDISK
Sector size (logical/physical): 512/512 bytes
Disk identifier (GUID): 8EFD04A2-473C-4FCA-9C89-459EEB658DB0
Partition table holds up to 128 entries
Main partition table begins at sector 2 and ends at sector 33
First usable sector is 34, last usable sector is 41943006
Partitions will be aligned on 2048-sector boundaries
Total free space is 2014 sectors (1007.0 KiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         1050623   512.0 MiB   EF00  EFI system partition
   2         1050624        41943006    19.5 GiB   8300  Linux filesystem
</code></pre><h3 id="4-prepare-the-encrypted-root-partition-refhttpswikiarchlinuxorgindexphpdm-cryptencrypting_an_entire_systemluks_on_a_partition">4. Prepare the encrypted root partition (<a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#LUKS_on_a_partition">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#4-prepare-the-encrypted-root-partition-refhttpswikiarchlinuxorgindexphpdm-cryptencrypting_an_entire_systemluks_on_a_partition">#</a></h3>
<p>Create and mount the encrypted root partition. You will need to choose the passphrase for the encryption!</p>
<pre><code># cryptsetup luksFormat /dev/sda2
# cryptsetup open /dev/sda2 cryptroot
# mkfs.ext4 /dev/mapper/cryptroot
# mount /dev/mapper/cryptroot /mnt
</code></pre><h3 id="5-prepare-the-boot-partition-refhttpswikiarchlinuxorgindexphpdm-cryptencrypting_an_entire_systempreparing_the_boot_partition">5. Prepare the boot partition (<a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#Preparing_the_boot_partition">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#5-prepare-the-boot-partition-refhttpswikiarchlinuxorgindexphpdm-cryptencrypting_an_entire_systempreparing_the_boot_partition">#</a></h3>
<p>Create and mount the non-encrypted boot partition.</p>
<pre><code># mkfs.fat -F32 /dev/sda1
# mkdir /mnt/boot
# mount /dev/sda1 /mnt/boot
</code></pre><h3 id="6-generate-an-fstab-file-refhttpswikiarchlinuxorgindexphpinstallation_guidefstab">6. Generate an fstab file (<a href="https://wiki.archlinux.org/index.php/installation_guide#Fstab">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#6-generate-an-fstab-file-refhttpswikiarchlinuxorgindexphpinstallation_guidefstab">#</a></h3>
<p>Run:</p>
<pre><code># genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
</code></pre><h3 id="7-install-essential-packages-refhttpswikiarchlinuxorgindexphpinstallation_guideinstall_essential_packages">7. Install essential packages (<a href="https://wiki.archlinux.org/index.php/installation_guide#Install_essential_packages">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#7-install-essential-packages-refhttpswikiarchlinuxorgindexphpinstallation_guideinstall_essential_packages">#</a></h3>
<p>Use the <code>pacstrap</code> script to install these packages. I added <code>vim</code> for editing config files and <code>dhcpcd</code> for connecting to the Internet after reboot.</p>
<pre><code># pacstrap /mnt base linux linux-firmware vim dhcpcd
</code></pre><h3 id="8-chroot-refhttpswikiarchlinuxorgindexphpinstallation_guidechroot">8. Chroot (<a href="https://wiki.archlinux.org/index.php/installation_guide#Chroot">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#8-chroot-refhttpswikiarchlinuxorgindexphpinstallation_guidechroot">#</a></h3>
<pre><code># arch-chroot /mnt
</code></pre><h3 id="9-time-zone-refhttpswikiarchlinuxorgindexphpinstallation_guidetime_zone">9. Time zone (<a href="https://wiki.archlinux.org/index.php/installation_guide#Time_zone">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#9-time-zone-refhttpswikiarchlinuxorgindexphpinstallation_guidetime_zone">#</a></h3>
<pre><code># ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
# hwclock --systohc
</code></pre><h3 id="10-localization-refhttpswikiarchlinuxorgindexphpinstallation_guidelocalization">10. Localization (<a href="https://wiki.archlinux.org/index.php/installation_guide#Localization">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#10-localization-refhttpswikiarchlinuxorgindexphpinstallation_guidelocalization">#</a></h3>
<p>Edit <code>/etc/locale.gen</code> and uncomment <code>en_US.UTF-8 UTF-8</code> and other needed locales. Generate the locales by running:</p>
<pre><code># locale-gen
# localectl set-locale LANG=en_US.UTF-8
</code></pre><h3 id="11-network-configuration-refhttpswikiarchlinuxorgindexphpinstallation_guidefstab">11. Network configuration (<a href="https://wiki.archlinux.org/index.php/installation_guide#Fstab">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#11-network-configuration-refhttpswikiarchlinuxorgindexphpinstallation_guidefstab">#</a></h3>
<p>Add the  <code>/etc/hosts</code>:</p>
<pre><code>127.0.0.1  localhost
::1        localhost
</code></pre><h3 id="12-configuring-mkinitcpio-refhttpswikiarchlinuxorgindexphpdm-cryptencrypting_an_entire_systemconfiguring_mkinitcpio">12. Configuring mkinitcpio (<a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#Configuring_mkinitcpio">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#12-configuring-mkinitcpio-refhttpswikiarchlinuxorgindexphpdm-cryptencrypting_an_entire_systemconfiguring_mkinitcpio">#</a></h3>
<p>Edit <code>/etc/mkinitcpio.conf</code>,</p>
<ul>
<li>add the <code>encrypt</code> hooks</li>
<li>move the <code>keyboard</code> hooks before <code>encrypt</code> ( so that you can type the passphrase :p )</li>
</ul>
<p>For example, after this step, <code>HOOKS</code> should look like:</p>
<pre><code>HOOKS=(base udev autodetect modconf block keyboard encrypt filesystems fsck)
</code></pre><h3 id="13-generate-the-initramfs-refhttpswikiarchlinuxorgindexphpinstallation_guideinitramfs">13. Generate the initramfs (<a href="https://wiki.archlinux.org/index.php/installation_guide#Initramfs">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#13-generate-the-initramfs-refhttpswikiarchlinuxorgindexphpinstallation_guideinitramfs">#</a></h3>
<p>Since we have changed to <code>/etc/mkinitcpio.conf</code> manually, we have to re-generates the boot images (e.g., <code>/boot/initramfs-linux.img</code>). Run this command:</p>
<pre><code># mkinitcpio -P
</code></pre><h3 id="14-set-the-root-password-refhttpswikiarchlinuxorgindexphpinstallation_guideroot_password">14. Set the root password (<a href="https://wiki.archlinux.org/index.php/installation_guide#Root_password">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#14-set-the-root-password-refhttpswikiarchlinuxorgindexphpinstallation_guideroot_password">#</a></h3>
<pre><code># passwd
</code></pre><h3 id="15-patch-the-cpus-microcode-refhttpswikiarchlinuxorgindexphpmicrocode">15. Patch the CPU&rsquo;s microcode (<a href="https://wiki.archlinux.org/index.php/Microcode">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#15-patch-the-cpus-microcode-refhttpswikiarchlinuxorgindexphpmicrocode">#</a></h3>
<ul>
<li>For AMD processors, install the <code>amd-ucode</code> package.</li>
<li>For Intel processors, install the <code>intel-ucode</code> package.</li>
</ul>
<p>For exmaple, run</p>
<pre><code># pacman -S intel-ucode
</code></pre><h3 id="16-configure-the-boot-loader-with-systemd-boot-refhttpswikiarchlinuxorgindexphpinstallation_guideboot_loader-systemd-boothttpswikiarchlinuxorgindexphpsystemd-boot">16. Configure the Boot Loader with <code>systemd-boot</code> (<a href="https://wiki.archlinux.org/index.php/installation_guide#Boot_loader">ref</a>, <a href="https://wiki.archlinux.org/index.php/Systemd-boot">systemd-boot</a>)<a hidden class="anchor" aria-hidden="true" href="#16-configure-the-boot-loader-with-systemd-boot-refhttpswikiarchlinuxorgindexphpinstallation_guideboot_loader-systemd-boothttpswikiarchlinuxorgindexphpsystemd-boot">#</a></h3>
<p><strong>16.1. Install the EFI boot manager</strong></p>
<pre><code># bootctl install
</code></pre><p><strong>16.2. Create <code>/boot/loader/entries/arch.conf</code></strong></p>
<ul>
<li>Replace <code>intel-ucode.img</code> with <code>amd-ucode.img</code> if you have an AMD CPU</li>
<li>Replace the <code>UUID</code> (not <code>PARTUUID</code>) to the one mapping to <code>/dev/sda2</code> (Run <code>blkid</code> to find out)</li>
</ul>
<pre><code>title   Arch Linux
linux   /vmlinuz-linux
initrd  /intel-ucode.img
initrd  /initramfs-linux.img
options cryptdevice=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX:cryptroot root=/dev/mapper/cryptroot rw
</code></pre><p><strong>16.3. Replace <code>/boot/loader/loader.conf</code> to</strong></p>
<pre><code>default      arch.conf
timeout      5
console-mode max
editor       no
</code></pre><p><strong>16.4. Review the configuration</strong></p>
<pre><code># bootctl list
Boot Loader Entries:
        title: Arch Linux (default)
           id: arch.conf
       source: /boot/loader/entries/arch.conf
        linux: /vmlinuz-linux
       initrd: /intel-ucode.img
               /initramfs-linux.img
      options: cryptdevice=UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX:cryptroot root=/dev/mapper/cryptroot rw
</code></pre><h3 id="17-reboot-refhttpswikiarchlinuxorgindexphpinstallation_guidereboot">17. Reboot (<a href="https://wiki.archlinux.org/index.php/installation_guide#Reboot">ref</a>)<a hidden class="anchor" aria-hidden="true" href="#17-reboot-refhttpswikiarchlinuxorgindexphpinstallation_guidereboot">#</a></h3>
<p>Exit the chroot environment by typing <code>exit</code> or pressing <code>Ctrl+d</code>. Then run <code>reboot</code>.</p>
<p>If everything works, it should ask for a password to access the cryptroot, like this screenshot below:</p>
<p><img src="./passphrase.png" alt="passphase"></p>
<p>One last thing, if you computer, like mine, is sitting behind a DHCP (e.g., a typical router), you will need to enable <code>dhcpcd</code> to access the Internet. Run,</p>
<pre><code># systemctl enable dhcpcd
</code></pre><p>Congratulations! You have installed Arch Linux with Full Disk Encryption!</p>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://whhone.github.io/blog/tags/privacy/">privacy</a></li>
      <li><a href="https://whhone.github.io/blog/tags/arch-linux/">arch-linux</a></li>
    </ul>
  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2021 <a href="https://whhone.github.io/blog/">Wai Hon&#39;s Blog</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>



<script defer src="/blog/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

</body>

</html>
